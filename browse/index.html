<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>iq4u8 ‚Äî Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <link rel="stylesheet" href="../assets/style.css">
    <style>
        /* Dashboard-specific overrides if needed */
        body {
            background: var(--bg2);
            overflow: hidden;
        }

        .app {
            display: flex !important;
        }

        /* Force show app */
    </style>
</head>

<body>
    <div class="app" id="app">
        <div class="sb">
            <div class="sbr">
                <div class="ic">‚ö°</div>
                <h2>iq4u8</h2>
            </div>
            <div class="sbn">
                <button class="ni a" onclick="sp('terminal',this)"><span
                        class="nx">üíª</span><span>Terminal</span></button>
                <button class="ni" onclick="sp('files',this)"><span class="nx">üìÇ</span><span>Files</span></button>
                <button class="ni" onclick="sp('plans',this)"><span class="nx">üíé</span><span>Plans</span></button>
                <button class="ni" onclick="sp('settings',this)"><span class="nx">‚öôÔ∏è
                    </span><span>Settings</span></button>
                <button class="ni" id="usersNav" style="display:none" onclick="sp('users',this)"><span
                        class="nx">üë•</span><span>Users</span></button>
            </div>
            <div class="res" id="resBox">
                <div class="res-t">Resources</div>
                <div class="rb">
                    <div class="rb-h"><span>Storage</span><span id="rbSt">‚Äî</span></div>
                    <div class="rb-bar">
                        <div class="rb-fill" id="rbSf" style="width:0"></div>
                    </div>
                </div>
                <div class="rb">
                    <div class="rb-h"><span>RAM</span><span id="cvRam">‚Äî</span></div>
                    <div style="height:40px"><canvas id="chartRam"></canvas></div>
                </div>
                <div class="rb">
                    <div class="rb-h"><span>CPU</span><span id="cvCpu">‚Äî</span></div>
                    <div style="height:40px"><canvas id="chartCpu"></canvas></div>
                </div>
                <!-- Storage Chart Hidden but kept for logic compatibility if needed -->
                <canvas id="chartStorage" style="display:none"></canvas>
            </div>
            <div class="sbf">
                <div class="ub">
                    <div class="ua" id="av">U</div>
                    <div class="mn">
                        <div class="un" id="un">User</div>
                        <div class="ur" id="ur">Plan</div>
                    </div>
                </div>
                <button class="bo" onclick="logout()">Sign Out</button>
            </div>
        </div>

        <div class="mn">
            <div class="mh">
                <h2 id="pt">Terminal</h2>
                <div class="bd" id="pb">FREE</div>
            </div>

            <!-- TERMINAL -->
            <div id="p-terminal" class="pn a">
                <div class="fb">
                    <div class="fbc">
                        <div class="fc">ssh user@iq4u8.hf.space</div>
                    </div>
                    <div class="fbs">
                        <button class="fb2" onclick="term.clear()">Clear</button>
                        <button class="fb2" onclick="location.reload()">Refresh</button>
                        <button class="fb2" onclick="toggleFullScreen()">Fullscreen</button>
                    </div>
                </div>
                <div id="tbox"></div>
            </div>

            <!-- FILES -->
            <div id="p-files" class="pn">
                <div class="fb">
                    <div class="fbc">
                        <button class="fc" onclick="loadFiles()">‚Üª</button>
                        <button class="fc" onclick="upDir()">‚¨Ü</button>
                        <span id="fp" style="font-size:11px;color:var(--txd)">/</span>
                    </div>
                    <div class="fbs">
                        <button class="fb2" onclick="mkDir()">+ Folder</button>
                        <button class="fb2" onclick="document.getElementById('upl').click()">+ Upload</button>
                        <input type="file" id="upl" multiple style="display:none" onchange="upl(this)">
                    </div>
                </div>
                <!-- Bulk Actions Toolbar -->
                <div class="fa-bar" id="faBar">
                    <button class="fa-btn" onclick="renameSelected()">‚úèÔ∏è Rename</button>
                    <button class="fa-btn" onclick="moveSelected()">üì¶ Move</button>
                    <button class="fa-btn" onclick="copySelected()">üìã Copy</button>
                    <button class="fa-btn danger" onclick="deleteSelected()">üóëÔ∏è Delete</button>
                    <button class="fa-btn danger" onclick="factoryReset()">üí£ Reset All</button>
                    <span class="fa-count" id="selCount">0 selected</span>
                </div>
                <div class="fl" id="fl"></div>
            </div>

            <!-- PLANS -->
            <div id="p-plans" class="pn">
                <div style="padding:20px;max-width:800px;margin:0 auto">
                    <h2 style="margin-bottom:20px">Upgrade Plan</h2>
                    <div class="lp-grid">
                        <div class="lp-card">
                            <div class="lp-head">Free</div>
                            <div class="lp-price">‚Çπ40<span
                                    style="font-size:12px;color:var(--txd);font-weight:400">/mo</span></div>
                            <ul class="lp-feat">
                                <li>0.5 CPU Core</li>
                                <li>280MB RAM</li>
                                <li>500MB Storage</li>
                                <li>Community Support</li>
                            </ul>
                            <button class="bgo" disabled>Current Plan</button>
                        </div>
                        <div class="lp-card" style="border-color:var(--ac);box-shadow:0 0 30px rgba(99,102,241,.15)">
                            <div class="lp-head" style="color:var(--ac)">Pro</div>
                            <div class="lp-price">‚Çπ70<span
                                    style="font-size:12px;color:var(--txd);font-weight:400">/mo</span></div>
                            <ul class="lp-feat">
                                <li>1 CPU Core</li>
                                <li>560MB RAM</li>
                                <li>1GB Storage</li>
                                <li>Priority Support</li>
                            </ul>
                            <button class="bgo"
                                onclick="window.open('https://wa.me/917620347246?text=I%20want%20to%20upgrade%20to%20Pro%20Plan','_blank')">Upgrade</button>
                        </div>
                        <div class="lp-card">
                            <div class="lp-head">Ultra</div>
                            <div class="lp-price">‚Çπ150<span
                                    style="font-size:12px;color:var(--txd);font-weight:400">/mo</span></div>
                            <ul class="lp-feat">
                                <li>2 CPU Cores</li>
                                <li>1120MB RAM</li>
                                <li>2GB Storage</li>
                                <li>Dedicated Support</li>
                            </ul>
                            <button class="bgo"
                                onclick="window.open('https://wa.me/917620347246?text=I%20want%20to%20upgrade%20to%20Ultra%20Plan','_blank')">Upgrade</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SETTINGS -->
            <div id="p-settings" class="pn">
                <div style="padding:20px;max-width:600px">
                    <h2 style="margin-bottom:20px">Profile Settings</h2>
                    <div class="fg"><label>Username</label><input type="text" id="setUn" disabled></div>
                    <div class="fg"><label>Role</label><input type="text" id="setRole" disabled></div>
                    <div class="fg"><label>Account Created</label><input type="text" id="setCreate" disabled></div>
                </div>
            </div>

            <!-- USERS (Owner Only) -->
            <div id="p-users" class="pn">
                <div style="padding:20px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                        <h2>User Management</h2>
                        <span id="uCnt" style="font-size:12px;color:var(--txd)">0 total</span>
                    </div>
                    <div class="fl" id="uTbl" style="padding:0"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modals -->
    <div class="md" id="pwM">
        <div class="mdc">
            <div class="mdt"><span>Change Password</span><button class="mdx"
                    onclick="this.closest('.md').classList.remove('sh')">√ó</button></div>
            <p id="pwUser" style="margin-bottom:10px;font-size:12px;color:var(--txd)"></p>
            <div class="fg"><input type="text" id="pwN" placeholder="New Password"></div><button class="bgo"
                onclick="pwGo()">Update</button>
        </div>
    </div>
    <div class="md" id="plM">
        <div class="mdc">
            <div class="mdt"><span>Change Plan</span><button class="mdx"
                    onclick="this.closest('.md').classList.remove('sh')">√ó</button></div>
            <p id="plUser" style="margin-bottom:10px;font-size:12px;color:var(--txd)"></p><select id="plSel"
                style="width:100%;padding:10px;background:var(--inp);color:var(--tx);border:1px solid var(--bdr);border-radius:9px;margin-bottom:15px">
                <option value="free">Free</option>
                <option value="pro">Pro</option>
                <option value="ultra">Ultra</option>
                <option value="banned">Banned</option>
            </select><button class="bgo" onclick="plGo()">Update</button>
        </div>
    </div>

    <!-- Alert Bar -->
    <div class="alert-bar warning" id="alertBar">
        <span id="alertMsg">‚ö†Ô∏è Alert</span>
        <button class="alert-x" onclick="closeAlert()">‚úï</button>
    </div>

    <!-- Mobile Toggle -->
    <button class="mob-toggle" onclick="toggleSb()">‚ò∞</button>

    <script src="../assets/main.js"></script>
    <script>
        function toggleSb() {
            document.querySelector('.sb').classList.toggle('open');
        }

        // DASHBOARD LOGIC
        if (!localStorage.getItem('token')) location.href = '/';
        const user = JSON.parse(atob(localStorage.getItem('token').split('.')[0] || '{}') || '{}'); // Mock decode if JWT, else redundant if token is opaque. 
        // Actually we fetch /api/check to get user details properly 
        let currentPath = '';
        let term, fitAddon;
        let selectedFiles = new Set();

        // Charts
        const charts = {};
        function makeChart(id, val, color) {
            const ctx = document.getElementById(id);
            if (!ctx) return;
            if (charts[id]) charts[id].destroy();
            charts[id] = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: ['Used', 'Free'], datasets: [{ data: [val, 100 - val], backgroundColor: [color, 'rgba(255,255,255,0.05)'], borderWidth: 0 }] },
                options: { cutout: '70%', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } }
            });
        }

        async function init() {
            try {
                const r = await api('/api/check');
                const d = await r.json();
                if (!d.loggedIn) logout();
                window.user = d.user;

                // Set Profile Info
                document.getElementById('un').textContent = user.username;
                document.getElementById('av').textContent = user.username[0].toUpperCase();
                document.getElementById('ur').textContent = (user.plan || 'free').toUpperCase();
                document.getElementById('pb').textContent = (user.plan || 'free').toUpperCase();
                document.getElementById('pb').className = 'bd bd' + (user.plan === 'pro' ? 'b' : user.plan === 'ultra' ? 'p' : 'g');

                document.getElementById('setUn').value = user.username;
                document.getElementById('setRole').value = user.role;
                document.getElementById('setCreate').value = new Date(user.createdAt || Date.now()).toLocaleDateString();

                if (user.role === 'owner') {
                    document.getElementById('usersNav').style.display = 'flex';
                }

                // Start Terminal
                initTerm();

                // Start Stats
                updateStats();
                setInterval(updateStats, 5000);

            } catch (e) { logout(); }
        }

        function sp(n, el) {
            document.querySelectorAll('.pn').forEach(p => p.style.display = 'none');
            document.querySelectorAll('.ni').forEach(b => b.classList.remove('a'));
            document.getElementById('p-' + n).style.display = n === 'terminal' ? 'flex' : 'block';
            if (n === 'terminal') { document.getElementById('p-terminal').classList.add('a'); if (term) fitAddon.fit(); }
            if (el) el.classList.add('a'); else document.querySelector(`.ni[onclick*="${n}"]`).classList.add('a');
            document.getElementById('pt').textContent = n.charAt(0).toUpperCase() + n.slice(1);

            if (n === 'files') loadFiles();
            if (n === 'users') lUsers();
        }

        // TERMINAL
        function initTerm() {
            term = new Terminal({ theme: { background: '#000', foreground: '#fff' }, fontFamily: 'monospace', fontSize: 13 });
            fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            term.open(document.getElementById('tbox'));
            fitAddon.fit();

            const ws = new WebSocket(WS_BASE + '/ws/terminal?token=' + localStorage.getItem('token'));
            ws.onopen = () => { term.write('\r\n\x1b[32mConnected to iq4u8 secure shell...\x1b[0m\r\n'); term.focus(); };
            ws.onmessage = e => term.write(e.data);
            ws.onclose = () => term.write('\r\n\x1b[31mConnection closed.\x1b[0m\r\n');
            term.onData(d => ws.send(JSON.stringify({ type: 'input', data: d })));
            window.addEventListener('resize', () => { fitAddon.fit(); ws.send(JSON.stringify({ type: 'resize', cols: term.cols, rows: term.rows })); });
        }

        function toggleFullScreen() {
            const t = document.getElementById('p-terminal');
            if (!document.fullscreenElement) t.requestFullscreen(); else document.exitFullscreen();
        }

        // STATS
        async function updateStats() {
            try {
                const r = await api('/api/system'); const d = await r.json();
                const used = d.diskPct || 0;
                document.getElementById('rbSf').style.width = used + '%';
                if (used > 80) document.getElementById('rbSf').classList.add('warn');
                document.getElementById('rbSt').textContent = d.diskUsed + ' / ' + d.diskTotal;

                makeChart('chartRam', d.ramPct || 0, '#3fb950');
                document.getElementById('cvRam').textContent = (d.ramPct || 0) + '%';

                makeChart('chartCpu', d.cpuPct || 0, '#f59e0b');
                document.getElementById('cvCpu').textContent = (d.cpuPct || 0) + '%';
            } catch (e) { }
        }

        // FILE MANAGER
        async function loadFiles() {
            try {
                const r = await api('/api/files/list', { method: 'POST', body: JSON.stringify({ path: currentPath }) });
                const d = await r.json();
                document.getElementById('fp').textContent = currentPath || '/';
                const fl = document.getElementById('fl');
                fl.innerHTML = '';
                selectedFiles.clear(); updateSelUI();

                // Add select all header
                if (d.files.length > 0) {
                    const head = document.createElement('div');
                    head.style.padding = '8px 40px'; head.style.borderBottom = '1px solid var(--bdr)';
                    head.innerHTML = `<div class="f-chk" onclick="toggleAllFiles(this)"></div>`;
                    fl.appendChild(head);
                }

                d.files.forEach(f => {
                    const el = document.createElement('div');
                    el.className = 'fi';
                    const isDir = f.type === 'directory';
                    el.innerHTML = `
                        <div class="f-chk" onclick="toggleFile('${f.name}', this); event.stopPropagation()"></div>
                        <div class="fii ${isDir ? 'd' : 'f'}">${isDir ? 'üìÇ' : 'üìÑ'}</div>
                        <div class="fin">${f.name}</div>
                        <div class="fis">${formatBytes(f.size)}</div>
                    `;
                    el.onclick = (e) => { if (!e.target.classList.contains('f-chk')) { if (isDir) { currentPath = (currentPath ? currentPath + '/' : '') + f.name; loadFiles(); } else dF(f.name); } };
                    fl.appendChild(el);
                });
            } catch (e) { }
        }

        function toggleFile(n, el) {
            const path = (currentPath ? currentPath + '/' : '') + n;
            if (selectedFiles.has(path)) { selectedFiles.delete(path); el.classList.remove('checked'); }
            else { selectedFiles.add(path); el.classList.add('checked'); }
            updateSelUI();
        }

        function toggleAllFiles(el) {
            const all = document.querySelectorAll('.fi .f-chk');
            const check = !el.classList.contains('checked');
            if (check) el.classList.add('checked'); else el.classList.remove('checked');

            all.forEach(c => {
                const n = c.parentElement.querySelector('.fin').textContent;
                const path = (currentPath ? currentPath + '/' : '') + n;
                if (check) { selectedFiles.add(path); c.classList.add('checked'); }
                else { selectedFiles.delete(path); c.classList.remove('checked'); }
            });
            updateSelUI();
        }

        function updateSelUI() {
            const c = selectedFiles.size;
            document.getElementById('selCount').textContent = c + ' selected';
            document.getElementById('faBar').className = 'fa-bar' + (c > 0 ? ' sh' : '');
        }

        function formatBytes(a, b = 2) { if (!+a) return "0 B"; const c = 0 > b ? 0 : b, d = Math.floor(Math.log(a) / Math.log(1024)); return parseFloat((a / Math.pow(1024, d)).toFixed(c)) + " " + ["B", "KB", "MB", "GB"][d] }
        function upDir() { if (!currentPath) return; currentPath = currentPath.split('/').slice(0, -1).join('/'); loadFiles(); }
        async function mkDir() { const n = prompt('Folder Name:'); if (n) await api('/api/files/mkdir', { method: 'POST', body: JSON.stringify({ path: (currentPath ? currentPath + '/' : '') + n }) }); loadFiles(); }
        async function upl(e) { const f = e.files; if (!f.length) return; const d = new FormData(); d.append('path', currentPath); for (const x of f) d.append('files', x); await api('/api/files/upload', { method: 'POST', headers: { 'Content-Type': undefined }, body: d }); loadFiles(); e.value = '' }
        async function dF(n) { const path = (currentPath ? currentPath + '/' : '') + n; location.href = API_BASE + '/api/files/download?token=' + localStorage.getItem('token') + '&path=' + encodeURIComponent(path); }

        async function renameSelected() {
            const f = [...selectedFiles][0]; if (!f) return;
            const nn = prompt('New name:', f.split('/').pop());
            if (nn) {
                await api('/api/files/rename', { method: 'PUT', body: JSON.stringify({ oldPath: f, newName: nn }) });
                loadFiles();
            }
        }
        async function moveSelected() {
            const d = prompt('Destination folder path (relative to root):', '');
            if (d !== null) {
                await api('/api/files/move', { method: 'POST', body: JSON.stringify({ sources: [...selectedFiles], destination: d }) });
                loadFiles();
            }
        }
        async function copySelected() {
            const d = prompt('Destination folder path (relative to root):', '');
            if (d !== null) {
                await api('/api/files/copy', { method: 'POST', body: JSON.stringify({ sources: [...selectedFiles], destination: d }) });
                loadFiles();
            }
        }
        async function deleteSelected() {
            if (!confirm(`Delete ${selectedFiles.size} items?`)) return;
            await api('/api/files/delete', { method: 'POST', body: JSON.stringify({ files: [...selectedFiles] }) });
            loadFiles();
        }
        async function factoryReset() {
            if (!confirm('DANGER: This will delete ALL your files. Continue?')) return;
            await api('/api/files/reset', { method: 'POST' });
            loadFiles();
        }

        // USER MANAGEMENT
        async function lUsers() {
            if (!user || user.role !== 'owner') return;
            try {
                const r = await api('/api/users'); const d = await r.json();
                document.getElementById('uCnt').textContent = d.users.length + ' total';
                let html = `<table class="ut"><thead><tr><th>User</th><th>IP</th><th>Status</th><th>Plan</th><th>Storage</th><th>Price</th><th>Actions</th></tr></thead><tbody>`;
                for (const u of d.users) {
                    const isOwn = u.role === 'owner';
                    const statusBadge = `<span class="u-status ${u.status}">${u.status}</span>`;
                    const approveBtn = u.status === 'pending' ? `<button class="u-act" style="background:rgba(63,185,80,.15);color:#3fb950" onclick="approveUser('${u.username}')">‚úÖ</button><button class="u-act del" onclick="rejectUser('${u.username}')">‚ùå</button>` : '';
                    html += `<tr>
                        <td><div class="u-name"><div class="u-av">${u.username[0].toUpperCase()}</div>${u.username}</div></td>
                        <td style="font-size:11px;color:var(--txd)">${u.lastIP || '‚Äî'}</td>
                        <td>${statusBadge}</td>
                        <td><span class="plan-badge plan-${u.plan}">${u.plan.toUpperCase()}</span></td>
                        <td style="font-size:10px">${u.storageMB}MB / ${u.storageLimit}</td>
                        <td style="font-weight:700">${u.price}</td>
                        <td>${isOwn ? '‚Äî' : approveBtn + `<button class="u-act" onclick="showPw('${u.username}')">üîë</button><button class="u-act" onclick="showPl('${u.username}','${u.plan}')">üíé</button><button class="u-act del" onclick="delUser('${u.username}')">üóëÔ∏è</button><button class="u-act del" onclick="banIP('${u.lastIP}')" title="Ban IP">üö´</button>`}</td>
                    </tr>`
                }
                html += '</tbody></table>';
                lBanned();
                document.getElementById('uTbl').innerHTML = html
            } catch (e) { document.getElementById('uTbl').innerHTML = '<div class="es"><span class="ei">‚ùå</span><p>Failed</p></div>' }
        }

        async function lBanned() {
            try {
                const r = await api('/api/ip/banned'); const d = await r.json();
                const ips = d.ips || [];
                let html = '<h3 style="margin:20px 0 10px">üö´ Banned IPs</h3><div class="ban-list" style="display:flex;flex-wrap:wrap;gap:8px">';
                if (ips.length === 0) html += '<span style="color:var(--txd);font-size:12px">No banned IPs</span>';
                else {
                    for (const ip of ips) html += `<span class="ban-tag" style="background:rgba(248,81,73,0.1);color:#f85149;padding:4px 8px;border-radius:6px;font-size:11px;display:flex;align-items:center;gap:6px">${ip} <button onclick="unbanIP('${ip}')" style="background:none;border:none;color:inherit;cursor:pointer">‚úï</button></span>`;
                }
                html += `</div><button class="u-act" style="margin-top:10px" onclick="promptBan()">+ Ban IP Manually</button>`;

                let bDiv = document.getElementById('banBox');
                if (!bDiv) {
                    bDiv = document.createElement('div'); bDiv.id = 'banBox';
                    document.getElementById('uTbl').after(bDiv);
                }
                bDiv.innerHTML = html;
            } catch (e) { }
        }
        async function promptBan() { const ip = prompt('Enter IP to ban:'); if (ip) banIP(ip); }
        async function banIP(ip) { if (!ip || ip === '‚Äî') return alert('No valid IP'); if (!confirm(`Ban IP: ${ip}? They will lose access immediately.`)) return; try { await api('/api/ip/ban', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ip }) }); lBanned(); } catch (e) { alert('Failed'); } }
        async function unbanIP(ip) { if (!confirm(`Unban IP: ${ip}?`)) return; try { await api('/api/ip/unban', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ip }) }); lBanned(); } catch (e) { alert('Failed'); } }
        async function approveUser(u) { if (!confirm('Approve "' + u + '"?')) return; try { const r = await api('/api/users/' + encodeURIComponent(u) + '/approve', { method: 'PUT' }); const d = await r.json(); if (d.success) { alert('‚úÖ ' + d.message); lUsers() } else alert('‚ùå ' + (d.error || 'Failed')) } catch (e) { alert('‚ùå Error') } }
        async function rejectUser(u) { if (!confirm('Reject & delete "' + u + '"?\n\nThis removes their account and all files.')) return; try { const r = await api('/api/users/' + encodeURIComponent(u) + '/reject', { method: 'PUT' }); const d = await r.json(); if (d.success) { alert('‚úÖ ' + d.message); lUsers() } else alert('‚ùå ' + (d.error || 'Failed')) } catch (e) { alert('‚ùå Error') } }
        async function delUser(u) { if (!confirm(`‚ö†Ô∏è  Delete "${u}"?\n\nThis deletes:\n‚Ä¢ Account\n‚Ä¢ All files\n‚Ä¢ Data\n\nCannot undo!`)) return; try { const r = await api('/api/users/' + encodeURIComponent(u), { method: 'DELETE' }); const d = await r.json(); if (d.success) { alert('‚úÖ ' + d.message); lUsers() } else alert('‚ùå ' + (d.error || 'Failed')) } catch (e) { alert('‚ùå Error') } }

        function showPw(u) { document.getElementById('pwM').classList.add('sh'); document.getElementById('pwUser').textContent = 'User: ' + u; document.getElementById('pwN').value = ''; document.getElementById('pwN').dataset.user = u; document.getElementById('pwN').focus() }
        async function pwGo() { const u = document.getElementById('pwN').dataset.user, p = document.getElementById('pwN').value; if (!p || p.length < 6) { alert('6+ characters required'); return } try { const r = await api('/api/users/' + encodeURIComponent(u) + '/password', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: p }) }); const d = await r.json(); if (d.success) { alert('‚úÖ ' + d.message); document.getElementById('pwM').classList.remove('sh') } else alert('‚ùå ' + (d.error || 'Failed')) } catch (e) { alert('‚ùå Error') } }
        function showPl(u, cur) { document.getElementById('plM').classList.add('sh'); document.getElementById('plUser').textContent = 'User: ' + u; document.getElementById('plSel').value = cur; document.getElementById('plSel').dataset.user = u }
        async function plGo() { const u = document.getElementById('plSel').dataset.user, p = document.getElementById('plSel').value; try { const r = await api('/api/users/' + encodeURIComponent(u) + '/plan', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ plan: p }) }); const d = await r.json(); if (d.success) { alert('‚úÖ ' + d.message); document.getElementById('plM').classList.remove('sh'); lUsers() } else alert('‚ùå ' + (d.error || 'Failed')) } catch (e) { alert('‚ùå Error') } }

        window.onload = init;
    </script>
</body>

</html>